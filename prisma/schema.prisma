generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_URL_UNPOOLED")
}

enum ContentStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
  ARCHIVED
}

enum MediaType {
  IMAGE
  VIDEO
  FILE
}

enum SeoTargetType {
  GLOBAL
  PAGE
  ARTICLE
}

enum SocialPlatform {
  INSTAGRAM
  PINTEREST
  TIKTOK
  FACEBOOK
  YOUTUBE
  LINKEDIN
  X
}

enum AiChannel {
  MAGAZIN
  INSTAGRAM
  PINTEREST
  TIKTOK
}

model AdminUser {
  id            String       @id @default(cuid())
  email         String       @unique
  name          String
  passwordHash  String
  role          String       @default("OWNER")
  isActive      Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  articles      Article[]    @relation("ArticleAuthor")
  uploadedMedia MediaAsset[] @relation("MediaUploader")
  auditLogs     AuditLog[]
}

model SiteSetting {
  id                    String          @id @default("global")
  siteName              String
  siteUrl               String
  brandTagline          String?
  defaultLocale         String          @default("de-DE")
  businessEmail         String?
  businessPhone         String?
  address               String?
  timezone              String          @default("Europe/Berlin")
  defaultSeoTitle       String?
  defaultSeoDescription String?
  trackingGa4Id         String?
  trackingGtmId         String?
  trackingMetaPixelId   String?
  trackingGoogleAdsId   String?
  socialAccounts        SocialAccount[]
  aiAgents              AiAgentConfig[]
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
}

model Page {
  id          String          @id @default(cuid())
  slug        String          @unique
  title       String
  headline    String?
  subheadline String?
  body        String?
  template    String          @default("standard")
  sections    Json?
  status      ContentStatus   @default(DRAFT)
  publishedAt DateTime?
  heroImageId String?
  heroImage   MediaAsset?     @relation("PageHeroImage", fields: [heroImageId], references: [id], onDelete: SetNull)
  mediaLinks  PageMediaLink[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([status])
}

model Article {
  id              String               @id @default(cuid())
  slug            String               @unique
  title           String
  excerpt         String?
  content         String
  status          ContentStatus        @default(DRAFT)
  publishedAt     DateTime?
  scheduledAt     DateTime?
  readTimeMinutes Int?
  coverImageId    String?
  coverImage      MediaAsset?          @relation("ArticleCoverImage", fields: [coverImageId], references: [id], onDelete: SetNull)
  authorId        String?
  author          AdminUser?           @relation("ArticleAuthor", fields: [authorId], references: [id], onDelete: SetNull)
  categories      ArticleCategoryMap[]
  tags            ArticleTagMap[]
  mediaLinks      ArticleMediaLink[]
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  @@index([status, publishedAt])
  @@index([scheduledAt])
}

model ArticleCategory {
  id        String               @id @default(cuid())
  name      String               @unique
  slug      String               @unique
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt
  articles  ArticleCategoryMap[]
}

model ArticleTag {
  id        String          @id @default(cuid())
  name      String          @unique
  slug      String          @unique
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  articles  ArticleTagMap[]
}

model ArticleCategoryMap {
  id         String          @id @default(cuid())
  articleId  String
  categoryId String
  article    Article         @relation(fields: [articleId], references: [id], onDelete: Cascade)
  category   ArticleCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([articleId, categoryId])
}

model ArticleTagMap {
  id        String     @id @default(cuid())
  articleId String
  tagId     String
  article   Article    @relation(fields: [articleId], references: [id], onDelete: Cascade)
  tag       ArticleTag @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([articleId, tagId])
}

model MediaAsset {
  id              String             @id @default(cuid())
  key             String             @unique
  url             String             @unique
  filename        String
  mimeType        String
  mediaType       MediaType
  sizeBytes       Int
  width           Int?
  height          Int?
  durationSeconds Int?
  title           String?
  altText         String?
  caption         String?
  uploadedById    String?
  uploadedBy      AdminUser?         @relation("MediaUploader", fields: [uploadedById], references: [id], onDelete: SetNull)
  pageHeroFor     Page[]             @relation("PageHeroImage")
  articleCoverFor Article[]          @relation("ArticleCoverImage")
  pageLinks       PageMediaLink[]
  articleLinks    ArticleMediaLink[]
  seoImages       SeoMeta[]          @relation("SeoOgImage")
  aliases         AssetAlias[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
}

model AssetAlias {
  id        String     @id @default(cuid())
  aliasPath String     @unique
  mediaId   String
  media     MediaAsset @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

model PageMediaLink {
  id        String     @id @default(cuid())
  pageId    String
  mediaId   String
  fieldKey  String
  page      Page       @relation(fields: [pageId], references: [id], onDelete: Cascade)
  media     MediaAsset @relation(fields: [mediaId], references: [id], onDelete: Restrict)
  createdAt DateTime   @default(now())

  @@unique([pageId, mediaId, fieldKey])
  @@index([mediaId])
}

model ArticleMediaLink {
  id        String     @id @default(cuid())
  articleId String
  mediaId   String
  fieldKey  String
  article   Article    @relation(fields: [articleId], references: [id], onDelete: Cascade)
  media     MediaAsset @relation(fields: [mediaId], references: [id], onDelete: Restrict)
  createdAt DateTime   @default(now())

  @@unique([articleId, mediaId, fieldKey])
  @@index([mediaId])
}

model SeoMeta {
  id                   String        @id @default(cuid())
  targetType           SeoTargetType
  targetId             String
  title                String?
  description          String?
  keywords             String?
  canonicalUrl         String?
  robots               String?
  openGraphTitle       String?
  openGraphDescription String?
  twitterCard          String?
  schemaType           String?
  extra                Json?
  ogImageId            String?
  ogImage              MediaAsset?   @relation("SeoOgImage", fields: [ogImageId], references: [id], onDelete: SetNull)
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  @@unique([targetType, targetId])
}

model SocialAccount {
  id            String         @id @default(cuid())
  siteSettingId String         @default("global")
  siteSetting   SiteSetting    @relation(fields: [siteSettingId], references: [id], onDelete: Cascade)
  platform      SocialPlatform
  displayName   String?
  handle        String?
  url           String
  isActive      Boolean        @default(true)
  sortOrder     Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@index([siteSettingId, sortOrder])
}

model AiAgentConfig {
  id             String      @id @default(cuid())
  siteSettingId  String      @default("global")
  siteSetting    SiteSetting @relation(fields: [siteSettingId], references: [id], onDelete: Cascade)
  channel        AiChannel   @unique
  isEnabled      Boolean     @default(false)
  promptTemplate String
  contentTone    String?
  timezone       String      @default("Europe/Berlin")
  runWindowStart String      @default("08:00")
  runWindowEnd   String      @default("10:00")
  frequencyMins  Int         @default(1440)
  targetLanguage String      @default("de")
  nextRunAt      DateTime?
  lastRunAt      DateTime?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
}

model AuditLog {
  id         String     @id @default(cuid())
  actorId    String?
  actor      AdminUser? @relation(fields: [actorId], references: [id], onDelete: SetNull)
  action     String
  entityType String
  entityId   String?
  payload    Json?
  createdAt  DateTime   @default(now())

  @@index([entityType, entityId])
  @@index([createdAt])
}

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  subject   String
  message   String
  ip        String?
  userAgent String?
  status    String   @default("NEW")
  createdAt DateTime @default(now())

  @@index([createdAt])
}

model ReservationRequest {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String
  date      String
  time      String
  guests    String
  note      String?
  ip        String?
  status    String   @default("NEW")
  createdAt DateTime @default(now())

  @@index([date, time])
  @@index([createdAt])
}
